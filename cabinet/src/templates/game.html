<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>The Splunk Arcade!</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.ico')}}">

        <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css')}}">

        <script src="https://code.jquery.com/jquery-latest.js"></script>


        <style>
            @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
            .press-start-2p-regular {
                font-family: "Press Start 2P", serif;
                font-weight: 400;
                font-style: normal;
            }
        </style>

        <script>
            let startTime = null;
            let attemptsCount = 0;

            function unlockQuizQuestion() {
                $.ajax({
                    type: 'GET',
                    url: '{{ url_for("routes.get_question", module=data.title) }}',
                    success: function(response) {
                        if (Object.keys(response).length === 0) {
                            console.log("player has seen all questions")

                            const quiz_message = document.getElementById("quiz-message")
                            quiz_message.textContent = "You answered all the questions, just play and chill now!";
                            return;
                        }

                        const question = response.question;

                        document.getElementById("quiz-message").style.display = "none";
                        document.getElementById("quiz-options").style.display = "block";
                        document.getElementById("quiz-question").textContent = question;

                        attemptsCount = 0;
                        startTime = new Date().getTime();

                        const optionsList = document.getElementById("quiz-answer-options");
                        optionsList.innerHTML = '';

                        const options = ['A', 'B', 'C', 'D'];
                        const randomizedPrompts = [...response.choices].sort(() => Math.random() - 0.5);

                        options.forEach((option, idx) => {
                            const li = document.createElement("li");
                            li.classList.add("flex", "items-center");

                            const input = document.createElement("input");
                            input.type = "radio";
                            input.name = "quiz-answer";
                            input.value = randomizedPrompts[idx].prompt;
                            input.id = `option-${option}`;
                            input.classList.add("mr-2", "accent-cyan-600");

                            const label = document.createElement("label");
                            label.setAttribute("for", `option-${option}`);
                            label.classList.add("text-white", "cursor-pointer");
                            label.textContent = randomizedPrompts[idx].prompt;

                            li.appendChild(input);
                            li.appendChild(label);

                            optionsList.appendChild(li);

                            if (randomizedPrompts[idx].is_correct) {
                                window.correctAnswer = option;
                            }
                        });

                        if (response.link) {
                            const linkElement = document.getElementById("quiz-link");
                            linkElement.href = response.link;
                            linkElement.target = "_blank";
                            linkElement.textContent = response.link_text;
                        }

                        const button = document.getElementById("open-right-drawer-btn");
                        button.classList.add("animate-bounce");
                        setTimeout(() => button.classList.remove("animate-bounce"), 5000);
                    },
                    error: function(error) {
                        console.log(error);
                    }
                });
            }

            function checkQuestionAnswer() {
                const selectedOption = document.querySelector('input[name="quiz-answer"]:checked');

                if (selectedOption) {
                    const selectedAnswer = selectedOption.id.split("-")[1];

                    const feedbackElement = document.createElement("div");
                    feedbackElement.classList.add("quiz-feedback", "absolute", "top-1/2", "left-1/2", "transform", "-translate-x-1/2", "px-4", "py-2", "rounded-lg", "transition-all", "duration-300");

                    attemptsCount++;

                    if (selectedAnswer === window.correctAnswer) {
                        const endTime = new Date().getTime();
                        const timeTaken = (endTime - startTime) / 1000;
                        feedbackElement.textContent = `Correct! It took you ${timeTaken.toFixed(2)} seconds and ${attemptsCount} attempt(s).`;
                        feedbackElement.classList.add("bg-green-500", "text-white");

                        console.log(`Time taken: ${timeTaken} seconds, Attempts: ${attemptsCount}`);

                        $.ajax({
                            type: 'POST',
                            url: '{{ url_for("routes.record_answer") }}',
                            data: JSON.stringify({
                                game_session_id: "{{ gamesession }}",
                                player_name: "{{ user_username }}",
                                title: "{{ data.title }}",
                                question: document.getElementById("quiz-question").textContent,
                                attempts: attemptsCount,
                                time_taken: timeTaken
                            }),
                            contentType: 'application/json',
                            success: function(response) {
                                console.log('Answer recorded successfully:', response);
                            },
                            error: function(error) {
                                console.log('Error recording answer:', error);
                            }
                        });

                        document.getElementById("quiz-options").style.display = "none";
                        document.getElementById("quiz-message").style.display = "block";
                        document.getElementById("quiz-link").style.display = "none";

                        startTime = null;
                        attemptsCount = 0;
                    } else {
                        feedbackElement.textContent = "Wrong answer. Try again!";
                        feedbackElement.classList.add("bg-red-500", "text-white");
                    }

                    document.body.appendChild(feedbackElement);

                    setTimeout(() => {
                        feedbackElement.classList.add("opacity-0");
                        setTimeout(() => feedbackElement.remove(), 500);
                    }, 2000);
                } else {
                    const feedbackElement = document.createElement("div");
                    feedbackElement.textContent = "Please select an answer before submitting.";
                    feedbackElement.classList.add("bg-yellow-500", "text-white", "absolute", "top-1/2", "left-1/2", "transform", "-translate-x-1/2", "px-4", "py-2", "rounded-lg");
                    document.body.appendChild(feedbackElement);

                    setTimeout(() => {
                        feedbackElement.classList.add("opacity-0");
                        setTimeout(() => feedbackElement.remove(), 500);
                    }, 2000);
                }
            }

        </script>
    </head>
    <body class="min-h-screen flex flex-col bg-gray-800 bg-cover bg-center py-2" style="background-image: url('{{ url_for('static', filename='images/arcade_bg_.png') }}');">
        <header>
            <img src="{{ url_for('static', filename='images/arcade__.png')}}" class="mx-auto h-32">
        </header>

        <nav class="bg-gray-800 text-white shadow-md py-2 opacity-90 relative">
            <ul class="flex justify-center space-x-8">
                <li><a href="{{ url_for('routes.home') }}" class="text-2xl tracking-wide press-start-2p-regular">Home</a></li>
                <li><a href="{{ scoreboard_endpoint }}" class="text-2xl tracking-wide press-start-2p-regular">Scoreboard</a></li>
                <li><a href="{{ logout_endpoint }}" class="text-2xl tracking-wide press-start-2p-regular">Logout</a></li>
            </ul>

            <a
                    id="open-left-drawer-btn"
                    onclick="toggleDrawer('left')"
                    class="text-sm tracking-wide press-start-2p-regular cursor-pointer absolute left-4 top-1/2 transform -translate-y-1/2"
            >
                Toggle Content
            </a>

            <a
                    id="open-right-drawer-btn"
                    onclick="toggleDrawer('right')"
                    class="text-sm tracking-wide press-start-2p-regular cursor-pointer absolute right-4 top-1/2 transform -translate-y-1/2"
            >
                Toggle Quiz
            </a>
        </nav>

        <main class="relative opacity-90 bg-gray-800 flex flex-col">
            <div class="flex h-auto">
                <div class="w-1/12 flex items-center justify-center"></div>

                <div id="game-container" class="flex flex-col w-full max-w-4xl py-2 h-auto mx-auto min-h-[600px]">
                    {% block content %}
                    {% if "imvader" in data.title %}
                    {% include 'cabinets/imvader.html' %}
                    {% elif "logger" in data.title %}
                    {% include 'cabinets/logger.html' %}
                    {% elif "bughunt" in data.title %}
                    {% include 'cabinets/bughunt.html' %}
                    {% endif %}
                    {% endblock %}
                </div>

                <div class="w-1/12 flex items-center justify-center"></div>
            </div>

            <div
                    id="left-drawer"
                    class="absolute left-0 w-64 bg-gray-800 text-white shadow-lg transform -translate-x-full transition-transform duration-300 z-50 h-full overflow-y-auto"
            >
                <ul class="p-4 space-y-2">
                    <div class="walkthrough" id="walkthrough"></div>
                </ul>

                <div class="flex justify-between items-center p-4 border-t border-gray-700">
                    <button
                            id="prev-stage"
                            class="bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 w-15 rounded-lg"
                    >
                        ←
                    </button>
                    <button
                            id="next-stage"
                            class="bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 w-15 rounded-lg"
                    >
                        →
                    </button>
                </div>
            </div>

            <div
                    id="right-drawer"
                    class="absolute right-0 w-64 bg-gray-800 text-white shadow-lg transform translate-x-full transition-transform duration-300 z-50 h-full overflow-y-auto"
            >
                <ul class="p-4">
                    <div class="quiz">
                        <p id="quiz-message" class="text-center text-xl font-semibold">Play a level to unlock a question.</p>

                        <div id="quiz-options" class="hidden space-y-4">
                            <p id="quiz-question" class="text-lg font-medium"></p>
                            <hr class="border-gray-600 my-4">
                            <ul id="quiz-answer-options" class="space-y-2">
                                <!-- populated from quiz fetch func -->
                            </ul>
                            <a id="quiz-link" class="text-cyan-400 hover:text-cyan-500 block mt-4 text-center"></a>
                            <button id="submit-answer" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white py-2 px-4 rounded-lg mt-4" onclick="checkQuestionAnswer()">
                                Submit Answer
                            </button>
                        </div>

                        <div id="quiz-feedback" class="mt-4 text-lg"></div>
                    </div>
                </ul>
            </div>

        </main>


        <script>
            function toggleDrawer(side) {
                const leftDrawer = document.getElementById('left-drawer');
                const rightDrawer = document.getElementById('right-drawer');

                if (side === 'left') {
                    leftDrawer.classList.toggle('-translate-x-full');
                } else if (side === 'right') {
                    rightDrawer.classList.toggle('translate-x-full');
                }
            }
        </script>
        <script>
            // this keeps the arrow keys from scrolling the page when playing a game
            const gameContainer = document.getElementById("game-container");

            gameContainer.addEventListener("keydown", function (event) {
                if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(event.key)) {
                    event.preventDefault();
                }
            });

            gameContainer.setAttribute("tabindex", "0");
            gameContainer.style.outline = "none";
            gameContainer.focus();
        </script>
        <script>
            // we want to disable scrolling (horizontally) so users dont see the "hidden" content panels
            document.body.style.overflowX = "hidden";
        </script>

        <script>
            let currentStage = 0;

            function fetchWalkthroughStage(stage) {
                $.ajax({
                    type: "GET",
                    url: "{{ url_for('routes.get_walkthrough', module=data.title, stage='') }}" + stage,
                    success: function (response) {
                        if (Object.keys(response).length === 0) {
                            currentStage = 0;
                            console.log("loop back over content....");
                            return fetchWalkthroughStage(currentStage);
                        }

                        const walkthroughElement = document.getElementById("walkthrough");

                        if (!walkthroughElement) {
                            console.error("Walkthrough element not found");
                            return;
                        }

                        walkthroughElement.innerHTML = "";

                        // title; replace w/ actual title/content when service is updated to
                        // return that ;p
                        const t = document.createElement("span");
                        t.className = "mr-4";
                        t.innerHTML = `<strong>${response.title}</strong>`;
                        walkthroughElement.appendChild(t);

                        const h = document.createElement("hr");
                        h.className = "border-gray-600 my-4";
                        walkthroughElement.appendChild(h);

                        const c = document.createElement("span");
                        c.className = "mr-4";
                        c.innerHTML = `${response.content}`;
                        walkthroughElement.appendChild(c);

                        const hh = document.createElement("hr");
                        hh.className = "border-gray-600 my-4";
                        walkthroughElement.appendChild(hh);

                        const l = document.createElement("span");
                        l.className = "mr-4";
                        l.innerHTML = `<a href="${response.hyperlink}"
   class="text-blue-600 hover:text-blue-800 font-semibold underline transition duration-300 ease-in-out"
   target="_blank" rel="noopener noreferrer">
    Find out more
</a>`;
                        walkthroughElement.appendChild(l);
                    },
                    error: function (error) {
                        console.error("Error fetching walkthrough stage:", error);
                    },
                });
            }

            function setupWalkthroughNavigation() {
                const prevButton = document.getElementById("prev-stage");
                const nextButton = document.getElementById("next-stage");

                if (prevButton && nextButton) {
                    prevButton.onclick = function () {
                        if (currentStage > 1) {
                            currentStage--;
                            fetchWalkthroughStage(currentStage);
                        } else {
                            alert("You're already at the first stage!");
                        }
                    };

                    nextButton.onclick = function () {
                        currentStage++;
                        fetchWalkthroughStage(currentStage);
                    };
                }
            }

            document.addEventListener("DOMContentLoaded", function () {
                fetchWalkthroughStage(currentStage);
                setupWalkthroughNavigation();
            });
        </script>



    </body>

    {% include 'footer.html' %}
</html>